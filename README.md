# Репозиторий для нагрузочного тестирования CouchDb

## Общее описание структуры

В данном репозитории можно протестировать скорость синхронизации PouchDb и CouchDb.

Config всех экспериметов содержится в `./config/experiments.json`.

Каждый config должен иметь примерно следующий вид:

```json
{
  "name": "Scale clients count", // имя эксперимента
  "execute": true, // нужно ли его выполнять
  "config": {
    // свойство clients_count будет изменяться каждую итерацию
    "changeProp": {
      "name": "clients_count",
      "min": 10,
      "max": 21,
      "step": 10
    },
    // неизменяемые свойства
    "constProp": {
      "count": 10,
      "json_size": 100,
      "json_height": 100,
      "json_arr_size": 5,
      "batch_size": 100
    }
  },
  // metadata для того чтобы построить график на основе эксперимента
  "chart": {
    "set_title": "Change clients from 10 to 20",
    "set_xlabel": "Clients count",
    "set_ylabel": "Time distribution, sec",
    "file_to_save": "ClientCountChange.png"
  }
}
```

Изменяемым может быть любое из свойств:

- **clients_count** - количество клиентов
- **count** - количество документов у каждого клиента
- **json_size** - размер json в байтах
- **json_height** - высота json дерева
- **json_arr_size** - максимальный размер массива во вложенной структуре json
- **batch_size** - внутреннее свойство PouchDb, количество документов, которое будет отправлено за 1 запрос

## Настройка окружения

Для начала экспериментов необходимо 2 машины, с установленным `SSH` соединением и прокинутыми портами `5984:5984` и `8080:8080`. Сделать это можно через команду `ssh -i <private_key> <пользователь>@<хост> -L 5984:localhost:5984 -L 8080:localhost:8080` порты необходимы для взаимодействия с CouchDb и KeyCloak.

1. На машине, которая будет выступать сервером, нужно запустить контейнеры CouchDb и KeyCloak. Для этого нужно выполнить `docker-compose up -d` из корня репозитория.

2. Запустить bash в контейнере CouchDb для сбора сведений о потреблении сервером CPU и RAM. Для этого с помощью `docker ps` получаем `container_id` и выполняем команду `/bin/bash`: `docker exec -it <container_id> \bin\bash`.
3. На клиентской машине выполнить `npm install` чтобы установить модули.

## Выполнение эксперимента

На клиенте при выполнении `python3 ExecuteExperiments.py` будут сформированы графики экспериментов, по которым можно понять скорость выполнения синхронизации, то есть количество затраченного времени. Графики находятся в папке `./charts`.
Скрипт будет периодически требовать пользовательского ввода, это нужно для того чтобы перезапустить команду на сервере для новой итерации.

На сервере формируются данные о потреблении CPU и RAM во время синхронизации, чтобы их собрать для каждой итерации каждого эксперимента необходимо предварительно выполнить команду `pidstat -h -d -r -u -p <номер процесса CouchDb> <интервал обновления> | grep --line-buffered '^[0-9]' > ./logs/<имя эксперимента и информация>.txt`(например `pdistat -h -d -r -u -p 9 1 `- считывает данные раз в секунду ) в контейнере CouchDb.

Для того чтобы получить графики потребления CPU и RAM в терминале сервера необходимо выполнить `python3 createCpuAndRamChart.py`. Скрипт создаст графики в папке logs.
